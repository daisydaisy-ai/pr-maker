<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PR Maker</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: #f5f5f7;
  min-height: 100vh;
  padding: 20px;
}
.container {
  background: white;
  border-radius: 16px;
  padding: 32px;
  max-width: 600px;
  margin: 0 auto;
  box-shadow: 0 4px 24px rgba(0,0,0,0.08);
}
h1 {
  font-size: 1.5rem;
  margin-bottom: 24px;
  text-align: center;
}
.field { margin-bottom: 16px; }
label {
  display: block;
  font-size: 0.85rem;
  font-weight: 600;
  color: #555;
  margin-bottom: 4px;
}
label .hint {
  font-weight: 400;
  color: #999;
  font-size: 0.75rem;
}
input, select, textarea {
  width: 100%;
  padding: 10px 12px;
  border: 1.5px solid #ddd;
  border-radius: 8px;
  font-size: 1rem;
  transition: border-color 0.2s;
}
input:focus, select:focus, textarea:focus {
  outline: none;
  border-color: #4a90d9;
}
.row {
  display: flex;
  gap: 12px;
}
.row .field { flex: 1; }
button {
  width: 100%;
  padding: 12px;
  background: #4a90d9;
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  margin-top: 8px;
  transition: background 0.2s;
}
button:hover { background: #3a7bc8; }
button:disabled { background: #aaa; cursor: not-allowed; }
#loading {
  display: none;
  text-align: center;
  padding: 20px;
  color: #888;
}
#results {
  margin-top: 24px;
  display: none;
}
.source-words {
  margin-bottom: 16px;
  padding: 12px;
  background: #f0f0f5;
  border-radius: 8px;
  font-size: 0.8rem;
  color: #666;
  max-height: 120px;
  overflow-y: auto;
}
.source-words summary {
  cursor: pointer;
  font-weight: 600;
  color: #555;
}
.result-card {
  background: #fafafa;
  border: 1px solid #eee;
  border-radius: 10px;
  padding: 16px;
  margin-bottom: 12px;
}
.result-card .label {
  font-size: 0.75rem;
  font-weight: 600;
  color: #4a90d9;
  margin-bottom: 6px;
}
.result-card .text {
  font-size: 1rem;
  line-height: 1.6;
  color: #333;
  margin-bottom: 8px;
  white-space: pre-wrap;
}
.result-card .meta {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.char-count {
  font-size: 0.8rem;
  color: #999;
}
.char-count.over { color: #e74c3c; font-weight: 600; }
.copy-btn {
  padding: 4px 16px;
  background: #34c759;
  color: white;
  border: none;
  border-radius: 6px;
  font-size: 0.85rem;
  cursor: pointer;
  font-weight: 600;
}
.copy-btn:hover { background: #2db84d; }
.copy-btn.copied { background: #888; }
.api-section {
  background: #fff8e1;
  border: 1px solid #ffe082;
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 16px;
}
.api-section label { color: #f57f17; }
.api-section input { font-size: 0.85rem; }
.api-section .hint-link {
  font-size: 0.75rem;
  color: #999;
}
.api-section .hint-link a { color: #4a90d9; }
.saved-badge {
  display: inline-block;
  font-size: 0.7rem;
  background: #34c759;
  color: white;
  padding: 1px 6px;
  border-radius: 4px;
  margin-left: 6px;
}
</style>
</head>
<body>
<div class="container">
  <h1>ğŸ“ PR Maker</h1>

  <div class="api-section">
    <div class="field" style="margin-bottom:4px;">
      <label for="api-key">ğŸ”‘ Gemini APIã‚­ãƒ¼ <span class="hint">ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã€å¤–éƒ¨é€ä¿¡ãªã—ï¼‰</span> <span id="saved-badge" class="saved-badge" style="display:none;">ä¿å­˜æ¸ˆ</span></label>
      <input type="password" id="api-key" placeholder="AIza...">
    </div>
    <p class="hint-link"><a href="https://aistudio.google.com/apikey" target="_blank">APIã‚­ãƒ¼ã‚’å–å¾— â†’</a></p>
  </div>

  <div class="field">
    <label for="url">ãƒšãƒ¼ã‚¸URL</label>
    <input type="url" id="url" placeholder="https://example.com/page">
  </div>
  <div class="row">
    <div class="field">
      <label for="platform">æŠ•ç¨¿å…ˆ</label>
      <select id="platform">
        <option value="x">Xï¼ˆæ—§Twitterï¼‰- 140å­—</option>
        <option value="instagram">Instagram - 2200å­—</option>
        <option value="facebook">Facebook - 500å­—ç›®å®‰</option>
        <option value="line">LINE - 500å­—ç›®å®‰</option>
        <option value="ad-short">åºƒå‘Šã‚­ãƒ£ãƒƒãƒï¼ˆçŸ­ï¼‰- 30å­—</option>
        <option value="ad-long">åºƒå‘Šã‚­ãƒ£ãƒƒãƒï¼ˆé•·ï¼‰- 90å­—</option>
        <option value="custom">ã‚«ã‚¹ã‚¿ãƒ </option>
      </select>
    </div>
    <div class="field">
      <label for="max-chars">æ–‡å­—æ•°ä¸Šé™</label>
      <input type="number" id="max-chars" value="140" min="10" max="5000">
    </div>
  </div>
  <div class="field">
    <label for="extra-instruction">è¿½åŠ æŒ‡ç¤º <span class="hint">ï¼ˆä»»æ„ï¼‰</span></label>
    <input type="text" id="extra-instruction" placeholder="ä¾‹: çµµæ–‡å­—ã‚’ä½¿ã£ã¦ã€å …ã‚ã®æ–‡ä½“ã§ã€ãªã©">
  </div>
  <button id="generate-btn" onclick="generate()">ğŸ¤– AI ã§æŠ•ç¨¿æ–‡ã‚’ç”Ÿæˆ</button>
  <div id="loading">ğŸ¤– AIãŒæŠ•ç¨¿æ–‡ã‚’è€ƒãˆä¸­...</div>
  <div id="results">
    <details class="source-words">
      <summary>æŠ½å‡ºã—ãŸç´ æãƒ†ã‚­ã‚¹ãƒˆ</summary>
      <p id="source-text"></p>
    </details>
    <div id="output"></div>
  </div>
</div>
<script>
const platformLimits = {
  'x': 140, 'instagram': 2200, 'facebook': 500,
  'line': 500, 'ad-short': 30, 'ad-long': 90, 'custom': 140
};
const platformNames = {
  'x': 'Xï¼ˆTwitterï¼‰', 'instagram': 'Instagram', 'facebook': 'Facebook',
  'line': 'LINE', 'ad-short': 'åºƒå‘Šã‚­ãƒ£ãƒƒãƒã‚³ãƒ”ãƒ¼ï¼ˆçŸ­æ–‡ï¼‰', 'ad-long': 'åºƒå‘Šã‚­ãƒ£ãƒƒãƒã‚³ãƒ”ãƒ¼ï¼ˆé•·æ–‡ï¼‰', 'custom': 'SNS'
};

// Save/load API key from localStorage
const apiKeyInput = document.getElementById('api-key');
const savedKey = localStorage.getItem('pr-maker-api-key');
if (savedKey) {
  apiKeyInput.value = savedKey;
  document.getElementById('saved-badge').style.display = 'inline-block';
}
apiKeyInput.addEventListener('change', function() {
  localStorage.setItem('pr-maker-api-key', this.value);
  document.getElementById('saved-badge').style.display = this.value ? 'inline-block' : 'none';
});

document.getElementById('platform').addEventListener('change', function() {
  document.getElementById('max-chars').value = platformLimits[this.value] || 140;
});

async function fetchPage(url) {
  const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url);
  const res = await fetch(proxyUrl);
  if (!res.ok) throw new Error('ãƒšãƒ¼ã‚¸ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
  return await res.text();
}

function extractText(html) {
  const doc = new DOMParser().parseFromString(html, 'text/html');
  doc.querySelectorAll('script,style,nav,footer,header,iframe,noscript').forEach(el => el.remove());

  const title = doc.querySelector('title')?.textContent?.trim() || '';
  const metaDesc = doc.querySelector('meta[name="description"]')?.getAttribute('content')?.trim() || '';
  const ogTitle = doc.querySelector('meta[property="og:title"]')?.getAttribute('content')?.trim() || '';
  const ogDesc = doc.querySelector('meta[property="og:description"]')?.getAttribute('content')?.trim() || '';

  const headings = [];
  doc.querySelectorAll('h1,h2,h3').forEach(h => {
    const t = h.textContent.trim();
    if (t && t.length > 2 && t.length < 200) headings.push(t);
  });

  const paragraphs = [];
  doc.querySelectorAll('p,li').forEach(p => {
    const t = p.textContent.trim();
    if (t && t.length > 10 && t.length < 500) paragraphs.push(t);
  });

  const keywords = [];
  doc.querySelectorAll('strong,em,b').forEach(el => {
    const t = el.textContent.trim();
    if (t && t.length > 1 && t.length < 50) keywords.push(t);
  });

  return { title, metaDesc, ogTitle, ogDesc, headings, paragraphs, keywords };
}

async function callGemini(apiKey, sourceText, platform, maxChars, extraInstruction) {
  const platformName = platformNames[platform] || 'SNS';
  const isAd = platform.startsWith('ad-');

  let prompt;
  if (isAd) {
    prompt = `ã‚ãªãŸã¯ãƒ—ãƒ­ã®åºƒå‘Šã‚³ãƒ”ãƒ¼ãƒ©ã‚¤ã‚¿ãƒ¼ã§ã™ã€‚
ä»¥ä¸‹ã®Webãƒšãƒ¼ã‚¸ã®å†…å®¹ã ã‘ã‚’ä½¿ã£ã¦ã€${platformName}ã‚’${maxChars}å­—ä»¥å†…ã§5ãƒ‘ã‚¿ãƒ¼ãƒ³ä½œã£ã¦ãã ã•ã„ã€‚

ãƒ«ãƒ¼ãƒ«ï¼š
- ãƒšãƒ¼ã‚¸ã«æ›¸ã‹ã‚Œã¦ã„ã‚‹è¨€è‘‰ã ã‘ã‚’ä½¿ã†ã“ã¨ï¼ˆå‹æ‰‹ã«æƒ…å ±ã‚’è¿½åŠ ã—ãªã„ï¼‰
- å„ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯ç•°ãªã‚‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§ï¼ˆç–‘å•å½¢ã€ä½“è¨€æ­¢ã‚ã€æ•°å­—æ´»ç”¨ã€æ„Ÿæƒ…è¨´æ±‚ã€è¡Œå‹•å–šèµ·ï¼‰
- å¿…ãš${maxChars}å­—ä»¥å†…ã«åã‚ã‚‹ã“ã¨
${extraInstruction ? '- ' + extraInstruction : ''}

---ãƒšãƒ¼ã‚¸å†…å®¹---
${sourceText}
---

ä»¥ä¸‹ã®JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼ˆä»–ã®ãƒ†ã‚­ã‚¹ãƒˆã¯ä¸è¦ï¼‰ï¼š
[{"label":"ãƒ‘ã‚¿ãƒ¼ãƒ³å","text":"ã‚³ãƒ”ãƒ¼æ–‡"}]`;
  } else {
    prompt = `ã‚ãªãŸã¯SNSé‹ç”¨ã®ãƒ—ãƒ­ã§ã™ã€‚
ä»¥ä¸‹ã®Webãƒšãƒ¼ã‚¸ã®å†…å®¹ã ã‘ã‚’ä½¿ã£ã¦ã€${platformName}å‘ã‘ã®æŠ•ç¨¿æ–‡ã‚’${maxChars}å­—ä»¥å†…ã§5ãƒ‘ã‚¿ãƒ¼ãƒ³ä½œã£ã¦ãã ã•ã„ã€‚

ãƒ«ãƒ¼ãƒ«ï¼š
- ãƒšãƒ¼ã‚¸ã«æ›¸ã‹ã‚Œã¦ã„ã‚‹è¨€è‘‰ã ã‘ã‚’ä½¿ã†ã“ã¨ï¼ˆå‹æ‰‹ã«æƒ…å ±ã‚’è¿½åŠ ã—ãªã„ï¼‰
- å„ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯ç•°ãªã‚‹ãƒˆãƒ¼ãƒ³ã§ï¼ˆãƒ•ã‚©ãƒ¼ãƒãƒ«ã€ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ã€ãƒ‹ãƒ¥ãƒ¼ã‚¹èª¿ã€å…±æ„Ÿå‹ã€è¡Œå‹•å–šèµ·å‹ï¼‰
- å¿…ãš${maxChars}å­—ä»¥å†…ã«åã‚ã‚‹ã“ã¨
- ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã¯å«ã‚ãªã„
${extraInstruction ? '- ' + extraInstruction : ''}

---ãƒšãƒ¼ã‚¸å†…å®¹---
${sourceText}
---

ä»¥ä¸‹ã®JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼ˆä»–ã®ãƒ†ã‚­ã‚¹ãƒˆã¯ä¸è¦ï¼‰ï¼š
[{"label":"ãƒ‘ã‚¿ãƒ¼ãƒ³å","text":"æŠ•ç¨¿æ–‡"}]`;
  }

  const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      contents: [{ parts: [{ text: prompt }] }],
      generationConfig: { temperature: 0.9 }
    })
  });

  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    throw new Error('Gemini API ã‚¨ãƒ©ãƒ¼: ' + (err.error?.message || res.status));
  }

  const json = await res.json();
  const raw = json.candidates?.[0]?.content?.parts?.[0]?.text || '';

  // Extract JSON from response
  const match = raw.match(/\[[\s\S]*\]/);
  if (!match) throw new Error('AIã®å¿œç­”ã‚’ãƒ‘ãƒ¼ã‚¹ã§ãã¾ã›ã‚“ã§ã—ãŸ');
  return JSON.parse(match[0]);
}

async function generate() {
  const apiKey = document.getElementById('api-key').value.trim();
  if (!apiKey) { alert('Gemini APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

  const url = document.getElementById('url').value.trim();
  if (!url) { alert('URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

  const platform = document.getElementById('platform').value;
  const maxChars = parseInt(document.getElementById('max-chars').value) || 140;
  const extraInstruction = document.getElementById('extra-instruction').value.trim();

  const btn = document.getElementById('generate-btn');
  btn.disabled = true;
  document.getElementById('loading').style.display = 'block';
  document.getElementById('results').style.display = 'none';

  try {
    // 1. Fetch and extract page text
    const html = await fetchPage(url);
    const data = extractText(html);

    const sourceItems = [
      data.title && ('ã‚¿ã‚¤ãƒˆãƒ«: ' + data.title),
      data.metaDesc && ('èª¬æ˜: ' + data.metaDesc),
      data.headings.length && ('è¦‹å‡ºã—: ' + data.headings.join(' / ')),
      data.keywords.length && ('ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ' + data.keywords.join(' / ')),
      data.paragraphs.length && ('æœ¬æ–‡: ' + data.paragraphs.slice(0, 5).join(' | '))
    ].filter(Boolean);
    const sourceText = sourceItems.join('\n');
    document.getElementById('source-text').textContent = sourceText;

    // 2. Call Gemini AI
    document.getElementById('loading').textContent = 'ğŸ¤– AIãŒæŠ•ç¨¿æ–‡ã‚’è€ƒãˆä¸­...';
    const texts = await callGemini(apiKey, sourceText, platform, maxChars, extraInstruction);

    // 3. Display results
    const output = document.getElementById('output');
    output.innerHTML = '';
    window._generatedTexts = texts;

    texts.forEach((item, i) => {
      const charCount = item.text.length;
      const isOver = charCount > maxChars;
      const card = document.createElement('div');
      card.className = 'result-card';
      card.innerHTML = `
        <div class="label">${escapeHtml(item.label)}</div>
        <div class="text">${escapeHtml(item.text)}</div>
        <div class="meta">
          <span class="char-count ${isOver ? 'over' : ''}">${charCount}/${maxChars}å­—</span>
          <button class="copy-btn" onclick="copyText(this, ${i})">ã‚³ãƒ”ãƒ¼</button>
        </div>
      `;
      output.appendChild(card);
    });

    document.getElementById('results').style.display = 'block';
  } catch (e) {
    alert('ã‚¨ãƒ©ãƒ¼: ' + e.message);
  } finally {
    btn.disabled = false;
    document.getElementById('loading').style.display = 'none';
  }
}

function copyText(btn, idx) {
  const text = window._generatedTexts[idx].text;
  navigator.clipboard.writeText(text).then(() => {
    btn.textContent = 'ã‚³ãƒ”ãƒ¼æ¸ˆ';
    btn.classList.add('copied');
    setTimeout(() => { btn.textContent = 'ã‚³ãƒ”ãƒ¼'; btn.classList.remove('copied'); }, 2000);
  });
}

function escapeHtml(str) {
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
}
</script>
</body>
</html>
